var bigRender=bigRender||{};!function(){"use strict";var a=function(a){this.commandChainModel=a,this.commandDispatcher=new bigRender.CommandDispatcher(a,null)},b=a.prototype;b.addCommand=function(a){var b=this.commandChainModel;b.commands.length>b.targetCommandPos&&b.commands.splice(0,b.targetCommandPos-1),b.commands.length===b.targetCommandPos&&b.targetCommandPos++,b.commands.push(a),this.commandDispatcher.start()},b.replaceLastCommand=function(a){this.clearLastCommand(),this.addCommand(a)},b.clearLastCommand=function(){var a=this.commandChainModel;a.commands.length>0&&(a.targetCommandPos--,this.commandDispatcher.start(),a.commands.pop())},b.clear=function(){var a=this.commandChainModel;a.commands=[],a.targetCommandPos=0},b.remove=function(){this.commandDispatcher.remove(),this.commandDispatcher=null},bigRender.CommandChainController=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a){bigRender.CommandChainController.call(this,a),this.model=a,this.layerManager=new bigRender.LayerManager(a,this.commandDispatcher),this.layerForwarder=new bigRender.LayerForwarder(a,this.commandDispatcher)},b=a.prototype=bigRender.CommandChainController.prototype;b.scroll=function(a,b){this.model.setScroll(a,b);for(var c=0;c<this.model.layers.length;c++){var d=this.model.layers[c];d.setScroll(a,b)}},b.highlightLayer=function(a){this.model.highlightLayer=a},b.getSaveState=function(){var a=this.model,b={};b.version=5,b.layers=[],b.width=a.width,b.height=a.height;for(var c=0;c<a.layers.length;c++){var d=a.layers[c];b.layers.push(d.copyOptions())}return b},b.setSaveState=function(a){this.clear();var b=this.model;b.setDimensions(a.width,a.height);for(var c=0;c<a.layers.length;c++){var d=a.layers[c],e=this.layerManager.createLayer();e.setOptions(d)}},b.undo=function(){this.model.targetCommandPos>0&&this.model.setTargetCommandPos(this.model.targetCommandPos-1)},b.redo=function(){this.model.targetCommandPos<this.model.commands.length&&this.model.setTargetCommandPos(this.model.targetCommandPos+1)},b.setTargetLayer=function(a){var b=this.model.getLayerById(a);this.model.setTargetLayer(b)},b.setDimensions=function(a,b){this.model.setDimensions(a,b);for(var c=0;c<this.model.layers.length;c++){var d=this.model.layers[c];d.setDimensions(a,y)}},b.CommandChainControllerClear=b.clear,b.clear=function(){this.CommandChainControllerClear(),this.commandDispatcher.clear(),this.model.clear()},b.CommandChainControllerRemove=b.remove,b.remove=function(){this.CommandChainControllerRemove(),this.layerManager.remove(),this.layerManager=null,this.layerForwarder.remove(),this.layerForwarder=null},bigRender.CompositionController=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a,b){this.compositionModel=a,this.commandDispatcher=b,this.layerCommands=[bigRender.command.ADD_OBJECT,bigRender.command.DRAW_IMAGE,bigRender.command.DRAW_LINE,bigRender.command.DRAW_SHAPE,bigRender.command.ERASE_RECT,bigRender.command.FLOOD_FILL,bigRender.command.MOVE_OBJECT,bigRender.command.MOVE_RECT,bigRender.command.REMOVE_OBJECT],_.bindAll(this,"_doPassForward","_undoPassForward"),this._addListeners()},b=a.prototype;b._addListeners=function(){for(var a=0;a<this.layerCommands.length;a++){var b=this.layerCommands[a];this.commandDispatcher.addEventListener(b+"Do",this._doPassForward),this.commandDispatcher.addEventListener(b+"Undo",this._undoPassForward)}},b._removeListeners=function(){for(var a=0;a<this.layerCommands.length;a++){var b=this.layerCommands[a];this.commandDispatcher.removeEventListener(b+"Do",this._doPassForward),this.commandDispatcher.removeEventListener(b+"Undo",this._undoPassForward)}},b._doPassForward=function(a){if(this.compositionModel.layers.length>0){a.command.layerId=a.command.layerId||this.compositionModel.targetLayer.layerId;var b=this.compositionModel.getLayerById(a.command.layerId);b.commands.push(a.command),b.setTargetCommandPos(b.commands.length)}},b._undoPassForward=function(a){var b=this.compositionModel.getLayerById(a.command.layerId);b&&(b.setTargetCommandPos(b.commands.length-1),b.commands.pop())},b.remove=function(){this._removeListeners(),this.commandDispatcher=null},bigRender.LayerForwarder=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a,b){this.model=a,this.commandDispatcher=b,_.bindAll(this,"_doCreateLayer","_undoCreateLayer","_doDeleteLayer","_undoDeleteLayer","_doEditLayer","_undoEditLayer"),this._createListeners()},b=a.prototype;b.createLayer=function(a){var b=new bigRender.LayerModel;return b.layerId=a||this.model.nextLayerId++,this.model.addLayer(b),this.model.targetLayer||this.model.setTargetLayer(b),b},b.remove=function(){this._removeListeners(),this.model=null,this.commandDispatcher=null},b._createListeners=function(){var a=this.commandDispatcher;a.addEventListener(bigRender.command.CREATE_LAYER+"Do",this._doCreateLayer),a.addEventListener(bigRender.command.CREATE_LAYER+"Undo",this._undoCreateLayer),a.addEventListener(bigRender.command.DELETE_LAYER+"Do",this._doDeleteLayer),a.addEventListener(bigRender.command.DELETE_LAYER+"Undo",this._undoDeleteLayer),a.addEventListener(bigRender.command.EDIT_LAYER+"Do",this._doEditLayer),a.addEventListener(bigRender.command.EDIT_LAYER+"Undo",this._undoEditLayer)},b._removeListeners=function(){var a=this.commandDispatcher;a.removeEventListener(bigRender.command.CREATE_LAYER+"Do",this._doCreateLayer),a.removeEventListener(bigRender.command.CREATE_LAYER+"Undo",this._undoCreateLayer),a.removeEventListener(bigRender.command.DELETE_LAYER+"Do",this._doDeleteLayer),a.removeEventListener(bigRender.command.DELETE_LAYER+"Undo",this._undoDeleteLayer),a.removeEventListener(bigRender.command.EDIT_LAYER+"Do",this._doEditLayer),a.removeEventListener(bigRender.command.EDIT_LAYER+"Undo",this._undoEditLayer)},b._doCreateLayer=function(a){var b=a.command;b.layerId=b.layerId||this.model.nextLayerId++;var c=this.createLayer(b.layerId);c.setOptions(a.command)},b._undoCreateLayer=function(a){var b=this.model.getLayerById(a.command.layerId);b&&(this.model.removeLayer(b),this._pickDefaultTargetLayer(b))},b._doDeleteLayer=function(a){var b=this.model.getLayerById(a.command.layerId);b&&(a.command.deletedLayer=b,this.model.removeLayer(b),this._pickDefaultTargetLayer(b))},b._undoDeleteLayer=function(a){var b=a.command.deletedLayer;this.model.addLayer(b)},b._doEditLayer=function(a){var b=this.model.getLayerById(a.command.layerId);b&&(a.command.oldOptions=b.copyOptions(),b.setOptions(a.command))},b._undoEditLayer=function(a){var b=this.model.getLayerById(a.command.layerId);b&&b.setOptions(a.command.oldOptions)},b._pickDefaultTargetLayer=function(a){var b=this.model;b.targetLayer&&b.targetLayer!==a||b.layers.length>0&&b.setTargetLayer(b.layers[0])},bigRender.LayerManager=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){this.clear()},b=a.prototype;createjs.EventDispatcher.initialize(b),b.clear=function(){this.commands=[],this.targetCommandPos=0},b.setTargetCommandPos=function(a){this.targetCommandPos=a,this.dispatchEvent({type:bigRender.event.COMMAND_POS_CHANGED,targetCommandPos:a})},bigRender.CommandChainModel=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){bigRender.CommandChainModel.call(this),this.clear()},b=a.prototype=bigRender.CommandChainModel.prototype;b.CommandChainModelClear=b.clear,b.clear=function(){this.CommandChainModelClear(),this.layers=[],this.targetLayer=null,this.highlightLayer=null,this.nextLayerId=1,this.nextObjectId=1,this.scrollX=0,this.scrollY=0,this.width=200,this.height=200},b.setDimensions=function(a,b){this.width=a,this.height=b,this.dispatchEvent({type:bigRender.event.DIMENSIONS_CHANGED,width:a,height:b})},b.setTargetLayer=function(a){this.targetLayer=a,this.dispatchEvent({type:bigRender.event.TARGET_LAYER_CHANGED,targetLayer:a})},b.addLayer=function(a){this.layers.push(a),this.dispatchEvent({type:bigRender.event.LAYER_ADDED,layer:a})},b.removeLayer=function(a){var b=this.layers.indexOf(a);-1!==b&&(this.layers.splice(b,1),this.dispatchEvent({type:bigRender.event.LAYER_REMOVED,layer:a}))},b.setScroll=function(a,b){this.scrollX=a,this.scrollY=b,this.dispatchEvent({type:bigRender.event.SCROLL_CHANGED,scrollX:a,scrollY:b})},b.getLayerById=function(a){for(var b=0;b<this.layers.length;b++){var c=this.layers[b];if(c.layerId===a)return c}},bigRender.CompositionModel=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){bigRender.CommandChainModel.call(this),this.layerId=null,this.name="Layer",this.zIndex=0,this.alpha=1,this.scrollPerc=1,this.scrollX=0,this.scrollY=0,this.visible=!0,this.active=!0,this.width=100,this.height=100},b=a.prototype=bigRender.CommandChainModel.prototype;b.setOptions=function(a){var b=bigRender.firstWithValue;this.name=b(a.name,this.name),this.zIndex=b(a.zIndex,this.zIndex),this.alpha=b(a.alpha,this.alpha),this.scrollPerc=b(a.scrollPerc,this.scrollPerc),this.visible=b(a.visible,this.visible),this.active=b(a.active,this.active),this.dispatchEvent(bigRender.event.LAYER_CHANGED)},b.setDimensions=function(a,b){this.width=a,this.height=b,this.dispatchEvent(bigRender.event.LAYER_RESIZED)},b.setScroll=function(a,b){(this.scrollX!==a||this.scrollY!==b)&&(this.scrollX=a,this.scrollY=b,this.dispatchEvent(bigRender.event.LAYER_CHANGED))},b.copyOptions=function(){var a=JSON.parse(JSON.stringify(this));return a},bigRender.LayerModel=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){this.maxStorage=100,this.canvases=[]},b=a.prototype;b.pop=function(a,b){var c;return c=this.canvases.length>0?this.canvases.pop():document.createElement("canvas"),a&&b&&(c.width=a,c.height=b),c},b.push=function(a){a.width=0,a.height=0;var b=a.getContext("2d");b.setTransform(1,0,0,1,0,0),this.canvases.length<this.maxStorage&&this.canvases.push(a)},bigRender.CanvasCache=new a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a){this.items=[],this.maxItems=a||10},b=a.prototype;b.store=function(a,b){var c=+new Date,d={key:a,item:b,time:c};this.items.push(d),this.forget()},b.retrieve=function(a){for(var b=0;b<this.items.length;b++){var c=this.items[b];if(c.key===a)return c.item}},b.forget=function(){for(;this.items.length>this.maxItems;)this.items.shift()},b.clear=function(){this.items=[]},bigRender.CappedStorage=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a,b){this.model=a,this.queue=b,this.commandPos=0,this.removed=!1,this.processing=!1,this.delayedStartTimeoutId=null,_.bindAll(this,"_commandPosChangedHandler","_partiallyProcessCommands","start"),this._addListeners()},b=a.prototype;createjs.EventDispatcher.initialize(b),b._addListeners=function(){this.model.addEventListener(bigRender.event.COMMAND_POS_CHANGED,this._commandPosChangedHandler)},b._removeListeners=function(){this.model.removeEventListener(bigRender.event.COMMAND_POS_CHANGED,this._commandPosChangedHandler)},b._commandPosChangedHandler=function(){this.start()},b.startIn=function(a){clearTimeout(this.delayedStartTimeoutId),this.delayedStartTimeoutId=setTimeout(this.start,a)},b.start=function(){this.processing=!0,this.queue?this.task=this.task||this.queue.doRecurring(this._partiallyProcessCommands):this._processCommands()},b.stop=function(){clearTimeout(this.delayedStartTimeoutId),this.processing=!1,this.task&&(this.task.remove(),this.task=null)},b.restart=function(){this.clear(),this.start()},b.dispatchCommand=function(a,b){var c=a.type+b,d={type:c,command:a};return this.dispatchEvent(d),d},b.clear=function(){this.stop(),this.commandPos=0},b.remove=function(){this.removed=!0,this.stop(),this.removeAllEventListeners(),this.model=null,this.queue=null,this.task=null},b._dispatchProgress=function(){var a=this.model.targetCommandPos/this.commandPos;this.dispatchEvent({type:bigRender.event.PROGRESS,percentCompleted:a}),this.commandPos===this.model.targetCommandPos&&this.dispatchEvent({type:bigRender.event.COMPLETE})},b._partiallyProcessCommands=function(){for(var a=20,b=+new Date,c=0,d=!1;a>c&&!d&&this.processing;)this._processCommands(10),c=+new Date-b,this.commandPos===this.model.targetCommandPos&&(d=!0);d&&this.stop()},b._processCommands=function(a){a=a||1/0;for(var b=0;this.commandPos!==this.model.targetCommandPos&&this.processing&&(this.commandPos<this.model.targetCommandPos?this._doNextCommand():this._undoLastCommand(),b++,!(b>=a)););this._dispatchProgress()},b._undoLastCommand=function(){this.commandPos--;var a=this._dispatchCurrentCommand("Undo");a||this.commandPos++},b._doNextCommand=function(){var a=this._dispatchCurrentCommand("Do");a&&this.commandPos++},b._dispatchCurrentCommand=function(a){var b=this.model.commands[this.commandPos],c=this.dispatchCommand(b,a),d=!0;return"repeat"===c.returnStatus&&(this.stop(),this.startIn(100),d=!1),d},bigRender.CommandDispatcher=a}();var bigRender=bigRender||{};!function(){"use strict";bigRender.firstWithValue=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(null!==b&&"undefined"!=typeof b)return b}}}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){this.images=new bigRender.CappedStorage(100),this.tintedImages=new bigRender.CappedStorage(5)},b=a.prototype;b.add=function(a){var b=a.getAttribute("src");this.images.store(b,a)},b.makeImg=function(a){var b=this.images.retrieve(a);return b||(b=document.createElement("img"),b.setAttribute("src",a),this.add(b)),b},b.makeTintedImg=function(a,b,c){if(0===c)return this.makeImg(a);var d=a+"-"+b+"-"+c,e=this.tintedImages.retrieve(d);if(!e){var f=this.makeImg(a);e=bigRender.ImageTinter.tint(f,b,c),e?this.tintedImages.store(d,e):e=f}return e},b.makeBitmap=function(a){var b=this.makeImg(a),c=new createjs.Bitmap(b);return c},b.remove=function(){this.images.clear(),this.images=null,this.tintedImages.clear(),this.tintedImages=null},bigRender.ImageCache=new a}();var bigRender=bigRender||{};!function(){"use strict";bigRender.ImageTinter={tint:function(a,b,c){if(0===a.width||0===a.height)return!1;var d=bigRender.CanvasCache.pop(a.width,a.height),e=d.getContext("2d");return e.fillStyle=b,e.fillRect(0,0,d.width,d.height),1>c&&e.drawImage(a,0,0),e.globalAlpha=c,e.globalCompositeOperation="destination-atop",e.drawImage(a,0,0),e.globalAlpha=1,e.globalCompositeOperation="source-over",d}}}();var bigRender=bigRender||{};!function(){"use strict";var a={};a.RAD_DEG=180/Math.PI,a.DEG_RAD=Math.PI/180,a.pythag=function(a,b){var c=Math.sqrt(a*a+b*b);return c},a.limit=function(a,b,c){return b>a&&(a=b),a>c&&(a=c),a},bigRender.Maths=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a){this.freq=a||33,this.q=[],this.i=0,this.batchSize=25,this.maxClogTime=10,this._runTasksBound=_.bind(this._runTasks,this),this.start()},b=a.prototype;b.doRecurring=function(a,b,c){b=b||this.freq,c=c||1/0;var d=new bigRender.Task(a,b,c);return this.q.push(d),d},b.doOnce=function(a,b){b=b||0;var c=this.doRecurring(a,b,1);return c},b.clear=function(){for(var a=0;a<this.q.length;a++){var b=this.q[a];b.remove()}this.q=[]},b.start=function(){this.stop(),this.interval=window.setInterval(this._runTasksBound,this.freq)},b.stop=function(){this.interval&&(window.clearInterval(this.interval),this.interval=null)},b.remove=function(){this.stop(),this.clear(),this.q=null},b._runTasks=function(){var a=+new Date,b=this.q.length;for(this.i>=b&&(this.i=0);this.i<b;){var c=this.q[this.i];if(c.done)b--,this._removeTask(c);else{this.i++;try{c.run(a)}catch(d){throw c.done=!0,d}}if(0===this.i%this.batchSize&&this._getElapsed(a)>this.maxClogTime)break}},b._removeTask=function(a){var b=this.q.indexOf(a);this.q.splice(b,1),a.remove()},b._getElapsed=function(a){var b=+new Date,c=b-a;return c},bigRender.Queue=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a,b,c){this.callback=a,this.freq=b||33,this.count=c||0,this.lastTime=+new Date,this.done=!1},b=a.prototype;b.run=function(a){var b=a-this.lastTime;b>=this.freq&&(this.lastTime=a,this.callback(this),this.count--,this.count<=0&&(this.done=!0))},b.remove=function(){this.done=!0,this.callback=null},bigRender.Task=a}();var bigRender=bigRender||{};!function(){"use strict";bigRender.ContextTools={applyStyle:function(a,b){b=b||{},a.setTransform(1,0,0,1,0,0);var c=b.rotation||0,d=b.scaleX||1,e=b.scaleY||1,f=b.translateX||0,g=b.translateY||0;a.translate(f,g),a.rotate(c*bigRender.Maths.DEG_RAD),a.scale(d,e),a.lineCap=b.lineCap||"round",a.lineJoin=b.lineJoin||"round",a.lineWidth=b.lineWidth||3,a.globalAlpha=b.globalAlpha||1,a.strokeStyle=b.strokeStyle||"#000000",a.fillStyle=b.fillStyle||"#000000",a.globalCompositeOperation=b.globalCompositeOperation||"source-over"},appendStyle:function(a,b){b=b||{},(b.translateX||b.translateY)&&a.translate(b.translateX,b.translateY),b.rotation&&a.rotate(b.rotation*bigRender.Maths.DEG_RAD),(b.scaleX||b.scaleY)&&a.scale(b.scaleX,b.scaleY),a.lineCap=b.lineCap||a.lineCap,a.lineJoin=b.lineJoin||a.lineJoin,a.lineWidth=b.lineWidth||a.lineWidth,a.globalAlpha=b.globalAlpha||a.globalAlpha,a.strokeStyle=b.strokeStyle||a.strokeStyle,a.fillStyle=b.fillStyle||a.fillStyle,a.globalCompositeOperation=b.globalCompositeOperation||a.globalCompositeOperation}}}();var bigRender=bigRender||{};!function(){"use strict";bigRender.ImageTools={drawImage:function(a,b){var c=b.color||b.tintColor||"#FFFFFF",d=b.tintPerc||0,e=bigRender.ImageCache.makeTintedImg(b.src,c,d),f=b.srcX||0,g=b.srcY||0,h=b.srcWidth||e.width,i=b.srcHeight||e.height,j=b.destX||b.x||0,k=b.destY||b.y||0,l=b.destWidth||e.width,m=b.destHeight||e.width;return j-=e.width/2,k-=e.height/2,0===e.width&&0===e.height?!1:(a.drawImage(e,f,g,h,i,j,k,l,m),!0)},moveRect:function(a,b){var c=b.src,d=b.dest,e=this.copyRect(c);this.drawRect(e,d.x,d.y,d.width,d.height,d.rotation,d.scaleX,d.scaleY),a.clearRect(c.x,c.y,c.width,c.height)},copyRect:function(a,b){var c=b.x,d=b.y,e=b.width,f=b.height,g=bigRender.Maths;c=g.limit(c,0,this.width),d=g.limit(d,0,this.height),e=g.limit(e,1,this.width-c),f=g.limit(f,1,this.height-d);var h=bigRender.CanvasCache.pop();h.width=e,h.height=f;var i=h.getContext("2d");i.drawImage(a,c,d,e,f,0,0,e,f)},deleteRect:function(a,b){var c=b.rect;a.clearRect(c.x,c.y,c.width,c.height)}}}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){},b=a.prototype;b.drawLine=function(a,b){var c=b.brush||"line",d=!0;return c===bigRender.brush.LINE?this.drawPathWithStrokes(a,b.path):d=this.drawPathWithSteps(a,b),d},b.drawPathWithStrokes=function(a,b){var c,d;a.beginPath();for(var e=0;e<b.length;e+=2)c=b[e],d=b[e+1],a.lineTo(c,d);2===b.length&&a.lineTo(c+.1,d),a.stroke()},b.drawPathWithSteps=function(a,b){for(var c=b.path,d=c[0],e=c[1],f=0,g=0,h=!0,i=0;i<c.length&&(f=c[i],g=c[i+1],b.startX=d,b.startY=e,b.endX=f,b.endY=g,h=this.drawLineWithSteps(a,b),h);i+=2)d=f,e=g;return h},b.drawLineWithSteps=function(a,b){for(var c,d,e,f,g=b.startX||0,h=b.startY||0,i=b.endX||0,j=b.endY||0,k=b.stepDist||1,l=b.useRounding||!0,m=g,n=h,o=i-g,p=j-h,q=bigRender.Maths.pythag(o,p),r=0,s=o/q*k,t=p/q*k,u=!0;q>=r&&(l?(e=Math.round(m),f=Math.round(n)):(e=m,f=n),e===c&&f===d||(u=this.drawStep(e,f,a,b)));)c=e,d=f,m+=s,n+=t,r+=k;return u},b.drawStep=function(a,b,c,d){var e;return bigRender.ContextTools.applyStyle(c,d),d.brush===bigRender.brush.IMAGE?(d.image.translateX=a,d.image.translateY=b,bigRender.ContextTools.appendStyle(c,d.image),e=bigRender.ImageTools.drawImage(c,d.image)):d.brush===bigRender.brush.PIXEL?e=bigRender.PixelTools.drawPixel(c,a,b,d.width,d.height):d.brush===bigRender.brush.SHAPE&&(d.shape.translateX=a,d.shape.translateY=b,bigRender.ContextTools.appendStyle(c,d.shape),e=bigRender.ShapeTools.drawShape(c,d.shape)),e},bigRender.LineTools=new a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){},b=a.prototype;b.drawPixel=function(a,b,c,d,e){return d=d||1,e=e||1,a.fillRect(b,c,d,e),!0},b.getPixel=function(a,b,c){var d=a.getImageData(b,c,1,1).data,e=new Color(d[0],d[1],d[2],d[3]);return e.getHex()},b.floodFill=function(a,b){var c=b.x||0,d=b.y||0,e=b.width||50,f=b.height||50,g=b.color||b.fillStyle||"#000000",h=Math.round(d-f/2),i=Math.round(c+e/2),j=Math.round(d+f/2),k=Math.round(c-e/2),l=a.getContext("2d");if(h=bigRender.Maths.limit(h,0,a.height),i=bigRender.Maths.limit(i,0,a.width),j=bigRender.Maths.limit(j,0,a.height),k=bigRender.Maths.limit(k,0,a.width),e=i-k,f=j-h,e>0&&f>0&&d>h&&i>c&&j>d&&c>k){var m=l.getImageData(k,h,e,f),n=this._simpleToRawColor(g);this.floodFillImageData({data:m.data,startX:c-k,startY:d-h,top:0,right:e,bottom:f,left:0,floodColor:n}),l.putImageData(m,k,h)}},b.floodFillImageData=function(a){var b,c,d,e,f,g,h=a.data,i=a.startX,j=a.startY,k=a.floodColor,l=a.top,m=a.right,n=a.bottom,o=a.left,p=m-o,q=[[i,j]];m-=1,n-=1,e=4*(j*p+i);for(var r=[h[e],h[e+1],h[e+2],h[e+3]];q.length;){for(b=q.pop(),c=b[0],d=b[1],e=4*(d*p+c);d>=l&&this._matchRawColor(h,e,r);)d-=1,e-=4*p;for(e+=4*p,d+=1,f=!1,g=!1;n>=d&&this._matchRawColor(h,e,r);)d+=1,this._colorRawPixel(h,e,k),c>o&&(this._matchRawColor(h,e-4,r)?f||(q.push([c-1,d]),f=!0):f&&(f=!1)),m>c&&(this._matchRawColor(h,e+4,r)?g||(q.push([c+1,d]),g=!0):g&&(g=!1)),e+=4*p}},b._simpleToRawColor=function(a){var b=new Color(a),c=[b._red,b._green,b._blue,Math.round(255*b._alpha)];return c},b._matchRawColor=function(a,b,c){return a[b]===c[0]&&a[b+1]===c[1]&&a[b+2]===c[2]&&a[b+3]===c[3]},b._colorRawPixel=function(a,b,c){a[b]=c[0],a[b+1]=c[1],a[b+2]=c[2],a[b+3]=c[3]},bigRender.PixelTools=new a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(){},b=a.prototype;b.graphics=new createjs.Graphics,b.drawShape=function(a,b){return bigRender.ShapeTools.drawShapePath(a,b),b.fill!==!1&&a.fill(),b.stroke!==!1&&a.stroke(),!0},b.drawShapePath=function(a,b){var c=b.shape||bigRender.shape.RECTANGLE;this.graphics.clear(),c===bigRender.shape.CIRCLE&&this._makeCirclePath(b),c===bigRender.shape.ELLIPSE&&this._makeEllipsePath(b),c===bigRender.shape.RECTANGLE&&this._makeRectanglePath(b),c===bigRender.shape.ROUND_RECTANGLE&&this._makeRoundRectPath(b),c===bigRender.shape.STAR&&this._makeStarPath(b),c===bigRender.shape.POLYGON&&this._makePolygonPath(b),this.graphics.drawAsPath(a)},b._makeCirclePath=function(a){var b=a.x||0,c=a.y||0,d=a.radius||10;this.graphics.drawCircle(b,c,d)},b._makeEllipsePath=function(a){var b=a.x||0,c=a.y||0,d=a.width||a.w||10,e=a.height||a.h||10;this.graphics.drawEllipse(b,c,d,e)},b._makeRectanglePath=function(a){var b=a.x||0,c=a.y||0,d=a.width||a.w||10,e=a.height||a.h||10;b-=d/2,c-=e/2,this.graphics.rect(b,c,d,e)},b._makeRoundRectPath=function(a){var b=a.x||0,c=a.y||0,d=a.width||a.w||10,e=a.height||a.h||10,f=a.radius||3;b-=d/2,c-=e/2,this.graphics.drawRoundRect(b,c,d,e,f)},b._makeStarPath=function(a){var b=a.x||0,c=a.y||0,d=a.radius||10,e=a.sides||5,f=a.pointSize||2,g=a.angle||0;this.graphics.drawPolyStar(b,c,d,e,f,g)},b._makePolygonPath=function(a){var b=a.x||0,c=a.y||0,d=a.radius||10,e=a.sides||3,f=0,g=a.angle||0;this.graphics.drawPolyStar(b,c,d,e,f,g)},bigRender.ShapeTools=new a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a,b,c){this.model=b,this.width=b.width,this.height=b.height,this.queue=c,this.canvas=a,this.stage=new createjs.Stage(this.canvas),this.stage.autoClear=!0,this.layers=[],_.bindAll(this,"_tickHandler","_targetLayerChangedHandler","_highlightLayerChangedHandler","_layerAddedHandler","_layerRemovedHandler","_layerChangedHandler","_commandPosChangedHandler"),this._addListeners()},b=a.prototype;b.getSaveState=function(){for(var a=[],b=0;b<this.layers.length;b++){var c=this.layers[b];a.push(c.getSaveState())}return a},b.setSaveState=function(a){for(var b=0;b<a.length;b++){var c=a[b],d=this._getLayerById(c.layerId);d&&d.setSaveState(c)}},b.update=function(){this.stage.update()},b.getSnapshot=function(a){return a=a||bigRender.CanvasCache.pop(this.canvas.width,this.canvas.height),a.getContext("2d").drawImage(this.canvas,0,0),a},b._getLayerById=function(a){for(var b=0;b<this.layers.length;b++){var c=this.layers[b];if(c.layerModel.layerId===a)return c}},b._addListeners=function(){var a=this.model;createjs.Ticker.addEventListener("tick",this._tickHandler),a.addEventListener(bigRender.event.TARGET_LAYER_CHANGED,this._targetLayerChangedHandler),a.addEventListener(bigRender.event.HIGHLIGHT_LAYER_CHANGED,this._highlightLayerChangedHandler),a.addEventListener(bigRender.event.LAYER_ADDED,this._layerAddedHandler),a.addEventListener(bigRender.event.LAYER_REMOVED,this._layerRemovedHandler),a.addEventListener(bigRender.event.LAYER_CHANGED,this._layerChangedHandler),a.addEventListener(bigRender.event.COMMAND_POS_CHANGED,this._commandPosChangedHandler)},b._removeListeners=function(){var a=this.model;createjs.Ticker.removeEventListener("tick",this._tickHandler),a.removeEventListener(bigRender.event.TARGET_LAYER_CHANGED,this._targetLayerChangedHandler),a.removeEventListener(bigRender.event.HIGHLIGHT_LAYER_CHANGED,this._highlightLayerChangedHandler),a.removeEventListener(bigRender.event.LAYER_ADDED,this._layerAddedHandler),a.removeEventListener(bigRender.event.LAYER_REMOVED,this._layerRemovedHandler),a.removeEventListener(bigRender.event.LAYER_CHANGED,this._layerChangedHandler),a.removeEventListener(bigRender.event.COMMAND_POS_CHANGED,this._commandPosChangedHandler)},b._tickHandler=function(){this.update()},b._targetLayerChangedHandler=function(){},b._highlightLayerChangedHandler=function(a){var b=a.command.layer;b?_.each(this.layers,function(a){a.layerModel===b?a.setDisplayOpacity(1):a.setDisplayOpacity(.5)}):_.each(this.layers,function(a){a.setDisplayOpacity(1)})},b._layerAddedHandler=function(a){var b=new bigRender.LayerView(a.layer,this.queue,this.width,this.height);this.stage.addChild(b),this.layers.push(b),this._sortLayers()},b._layerRemovedHandler=function(a){var b=_.find(this.layers,function(b){return b.layerId===a.command.layerId});b&&(b.remove(),this.layers=_.without(this.layers,b)),this._sortLayers()},b._layerChangedHandler=function(){},b._commandPosChangedHandler=function(){},b._sortLayers=function(){this.layers.sort(function(a,b){return a.z-b.z});for(var a=0;a<this.layers.length;a++){var b=this.layers[a];this.stage.addChild(b)}},b.clear=function(){this.stage.removeAllChildren(),this.layers=[]},b.remove=function(){this._removeListeners()},bigRender.CompositionView=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a,b,c){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.commandDispatcher=a,createjs.Bitmap.call(this,this.canvas),_.bindAll(this,"_doDrawImageHandler","_doDrawLineHandler","_doDrawShapeHandler","_doEraseRectHandler","_doMoveRectHandler","_doFloodFillHandler","_redrawHandler"),this._addListeners(),this.setDimensions(b,c)},b=a.prototype=new createjs.Bitmap;b.getSaveState=function(){var a=this.canvas.toDataURL();return a},b.setSaveState=function(a){var b=document.createElement("img");b.setAttribute("src",a),this.clear(),this.ctx.drawImage(b,0,0)},b.setDimensions=function(a,b){(a!==this.canvas.width||b!==this.canvas.height)&&(this.canvas.width=a,this.canvas.height=b,this.redraw())},b.redraw=function(){this.clear(),this.commandDispatcher.start()},b.clear=function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.commandDispatcher.clear()},b.remove=function(){this.clear(),this._removeListeners(),this.canvas=null,this.ctx=null,this.commandDispatcher=null},b._addListeners=function(){var a=this.commandDispatcher;a.addEventListener(bigRender.command.DRAW_IMAGE+"Do",this._doDrawImageHandler),a.addEventListener(bigRender.command.DRAW_IMAGE+"Undo",this._redrawHandler),a.addEventListener(bigRender.command.DRAW_LINE+"Do",this._doDrawLineHandler),a.addEventListener(bigRender.command.DRAW_LINE+"Undo",this._redrawHandler),a.addEventListener(bigRender.command.DRAW_SHAPE+"Do",this._doDrawShapeHandler),a.addEventListener(bigRender.command.DRAW_SHAPE+"Undo",this._redrawHandler),a.addEventListener(bigRender.command.ERASE_RECT+"Do",this._doEraseRectHandler),a.addEventListener(bigRender.command.ERASE_RECT+"Undo",this._redrawHandler),a.addEventListener(bigRender.command.MOVE_RECT+"Do",this._doMoveRectHandler),a.addEventListener(bigRender.command.MOVE_RECT+"Undo",this._redrawHandler),a.addEventListener(bigRender.command.FLOOD_FILL+"Do",this._doFloodFillHandler),a.addEventListener(bigRender.command.FLOOD_FILL+"Undo",this._redrawHandler)},b._removeListeners=function(){var a=this.commandDispatcher;a.removeEventListener(bigRender.command.DRAW_IMAGE+"Do",this._doDrawImageHandler),a.removeEventListener(bigRender.command.DRAW_IMAGE+"Undo",this._redrawHandler),a.removeEventListener(bigRender.command.DRAW_LINE+"Do",this._doDrawLineHandler),a.removeEventListener(bigRender.command.DRAW_LINE+"Undo",this._redrawHandler),a.removeEventListener(bigRender.command.DRAW_SHAPE+"Do",this._doDrawShapeHandler),a.removeEventListener(bigRender.command.DRAW_SHAPE+"Undo",this._redrawHandler),a.removeEventListener(bigRender.command.ERASE_RECT+"Do",this._doEraseRectHandler),a.removeEventListener(bigRender.command.ERASE_RECT+"Undo",this._redrawHandler),a.removeEventListener(bigRender.command.MOVE_RECT+"Do",this._doMoveRectHandler),a.removeEventListener(bigRender.command.MOVE_RECT+"Undo",this._redrawHandler),a.removeEventListener(bigRender.command.FLOOD_FILL+"Do",this._doFloodFillHandler),a.removeEventListener(bigRender.command.FLOOD_FILL+"Undo",this._redrawHandler)},b._doDrawImageHandler=function(a){bigRender.ContextTools.applyStyle(this.ctx,a.command),bigRender.ImageTools.drawImage(this.ctx,a.command)},b._doDrawLineHandler=function(a){bigRender.ContextTools.applyStyle(this.ctx,a.command);var b=bigRender.LineTools.drawLine(this.ctx,a.command);b||(a.returnStatus="repeat")},b._doDrawShapeHandler=function(a){bigRender.ContextTools.applyStyle(this.ctx,a.command),bigRender.ShapeTools.drawShape(this.ctx,a.command)},b._doEraseRectHandler=function(a){bigRender.ContextTools.applyStyle(this.ctx,a.command),bigRender.ImageTools.eraseRect(this.ctx,a.command)},b._doMoveRectHandler=function(a){bigRender.ContextTools.applyStyle(this.ctx,a.command),bigRender.ImageTools.moveRect(this.ctx,a.command)},b._doFloodFillHandler=function(a){bigRender.ContextTools.applyStyle(this.ctx,a.command),bigRender.PixelTools.floodFill(this.canvas,a.command)},b._redrawHandler=function(){this.redraw()},bigRender.LayerBitmapView=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a){createjs.Container.call(this),this.commandDispatcher=a,this.lookup=[],_.bindAll(this,"_doAddObjectHandler","_undoAddObjectHandler","_doMoveObjectHandler","_undoMoveObjectHandler","_doRemoveObjectHandler","_undoRemoveObjectHandler"),this._addListeners()},b=a.prototype=new createjs.Container;b.nextObjectId=1,b.getSaveState=function(){for(var a={},b=[],c=0;c<this.children.length;c++){var d=this.children[c],e={x:d.x,y:d.y};0!==d.rotation&&(e.rotation=d.rotation),1!==d.alpha&&(e.alpha=d.alpha),1!==d.scaleX&&(e.scaleX=d.scaleX),1!==d.scaleY&&(e.scaleY=d.scaleY),0!==d.skewX&&(e.skewX=d.skewX),0!==d.skewY&&(e.skewY=d.skewY),"center"!==d.rawRegX&&(e.regX=d.rawRegX),"center"!==d.rawRegY&&(e.regY=d.rawRegY)}return a.commands=b,a},b.setSaveState=function(a){this.clear();for(var b=0;b<a.length;b++){var c=a[b];this.addImage(c)}},b.addImage=function(a){var b=a.src,c=a.id||a.objectId||this.nextObjectId++,d=bigRender.ImageCache.makeBitmap(b);d.objectId=a.objectId=c,this.lookup[c]=d,this.addChild(d),this._positionObject(a,d)},b.clear=function(){this.removeAllChildren(),this.lookup=[]},b.remove=function(){this.clear(),this._removeListeners()},b._addListeners=function(){var a=this.commandDispatcher;a.addEventListener(bigRender.command.ADD_OBJECT+"Do",this._doAddObjectHandler),a.addEventListener(bigRender.command.ADD_OBJECT+"Undo",this._undoAddObjectHandler),a.addEventListener(bigRender.command.MOVE_OBJECT+"Do",this._doMoveObjectHandler),a.addEventListener(bigRender.command.MOVE_OBJECT+"Undo",this._undoMoveObjectHandler),a.addEventListener(bigRender.command.REMOVE_OBJECT+"Do",this._doRemoveObjectHandler),a.addEventListener(bigRender.command.REMOVE_OBJECT+"Undo",this._undoRemoveObjectHandler)},b._removeListeners=function(){var a=this.commandDispatcher;
a.removeEventListener(bigRender.command.ADD_OBJECT+"Do",this._doAddObjectHandler),a.removeEventListener(bigRender.command.ADD_OBJECT+"Undo",this._undoAddObjectHandler),a.removeEventListener(bigRender.command.MOVE_OBJECT+"Do",this._doMoveObjectHandler),a.removeEventListener(bigRender.command.MOVE_OBJECT+"Undo",this._undoMoveObjectHandler),a.removeEventListener(bigRender.command.REMOVE_OBJECT+"Do",this._doRemoveObjectHandler),a.removeEventListener(bigRender.command.REMOVE_OBJECT+"Undo",this._undoRemoveObjectHandler)},b._doAddObjectHandler=function(a){var b=bigRender.ImageCache.makeImg(a.command.src);0===b.width?a.returnStatus="repeat":this.addImage(a.command)},b._undoAddObjectHandler=function(a){var b=this.lookup[a.command.objectId];b&&(this.removeChild(b),delete this.lookup[a.command.objectId])},b._doMoveObjectHandler=function(a){var b=this.lookup[a.command.objectId];b&&(a.command.restore=this._copyObjectPosition(b),this._positionObject(a.command,b))},b._undoMoveObjectHandler=function(a){var b=this.lookup[a.command.objectId];b&&this._positionObject(a.command.restore,b)},b._doRemoveObjectHandler=function(a){var b=this.lookup[a.command.objectId];b&&this.removeChild(b)},b._undoRemoveObjectHandler=function(a){var b=this.lookup[a.command.objectId];b&&this.addChild(b)},b._positionObject=function(a,b){var c=bigRender.firstWithValue,d=b||this.lookup[a.objectId];if(d){d.x=c(a.x,d.x),d.y=c(a.y,d.y),d.scaleX=c(a.scaleX,d.scaleX),d.scaleY=c(a.scaleY,d.scaleY),d.rotation=c(a.rotation,d.rotation),d.alpha=c(a.alpha,d.alpha),d.skewX=c(a.skewX,d.skewX),d.skewY=c(a.skewY,d.skewY);var e=c(a.regX,a.rawRegX,d.rawRegX,"center"),f=c(a.regY,a.rawRegY,d.rawRegY,"center");"number"==typeof e&&(d.regX=e),"number"==typeof f&&(d.regY=f),d instanceof createjs.Bitmap&&("center"===e&&(d.regX=d.image.width/2),"left"===e&&(d.regX=0),"right"===e&&(d.regX=d.image.width),"top"===f&&(d.regY=0),"center"===f&&(d.regY=d.image.height/2),"bottom"===f&&(d.regY=d.image.height)),d.rawRegX=e,d.rawRegY=f}},b._copyObjectPosition=function(a){var b={};return b.x=a.x,b.y=a.y,b.scaleX=a.scaleX,b.scaleY=a.scaleY,b.rotation=a.rotation,b.alpha=a.alpha,b.skewX=a.skewX,b.skewY=a.skewY,b},bigRender.LayerObjectView=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a,b,c,d){createjs.Container.call(this),this.displayAlpha=1,this.layerModel=a,this.commandDispatcher=new bigRender.CommandDispatcher(a,b),this.bitmap=new bigRender.LayerBitmapView(this.commandDispatcher,c,d),this.objectHolder=new bigRender.LayerObjectView(this.commandDispatcher),this.addChild(this.bitmap),this.addChild(this.objectHolder),_.bindAll(this,"_layerChangedHandler"),this._addListeners()},b=a.prototype=new createjs.Container;b.getSaveState=function(){var a={};return a.image=this.bitmap.getSaveState(),a.objects=this.objectHolder.getSaveState(),a.layerId=this.layerModel.layerId,a},b.setSaveState=function(a){this.bitmap.setSaveState(a.image),this.objectHolder.setSaveState(a.objects)},b.updateDisplay=function(){var a=this.layerModel;this.x=a.scrollX*a.scrollPerc,this.y=a.scrollY*a.scrollPerc,this.alpha=a.alpha*this.displayAlpha,this.visible=a.visible},b.setDisplayAlpha=function(a){this.displayAlpha=a,this.updateDisplay()},b.getObjectsUnderPoint=function(a,b){return this.objectHolder.getObjectsUnderPoint(a,b)},b.getObjectsUnderRect=function(a){return this.objectHolder.getObjectsUnderRect(a)},b.copy=function(){},b.clear=function(){},b.remove=function(){this._removeListeners(),this.clear()},b._addListeners=function(){this.layerModel.addEventListener(bigRender.event.LAYER_CHANGED,this._layerChangedHandler),this.layerModel.addEventListener(bigRender.event.LAYER_RESIZED,this._layerResizedHandler)},b._removeListeners=function(){this.layerModel.removeEventListener(bigRender.event.LAYER_CHANGED,this._layerChangedHandler),this.layerModel.removeEventListener(bigRender.event.LAYER_RESIZED,this._layerResizedHandler)},b._layerChangedHandler=function(){this.updateDisplay()},b._layerResizedHandler=function(a){this.bitmap.setDimensions(a.width,a.height)},bigRender.LayerView=a}();var bigRender=bigRender||{};!function(){"use strict";var a=function(a){"string"==typeof a&&(a=document.getElementById(a)),this.queue=new bigRender.Queue,this.model=new bigRender.CompositionModel,this.controller=new bigRender.CompositionController(this.model),this.view=new bigRender.CompositionView(a,this.model,this.queue),this._setupFunctionForwarding(),this.setDimensions(a.width,a.height)},b=a.prototype;b.getSaveState=function(){var a={};return a.settings=this.controller.getSaveState(),a.graphics=this.view.getSaveState(),a},b.setSaveState=function(a){this.clear(),this.controller.setSaveState(a.settings),this.view.setSaveState(a.graphics)},b.setDimensions=function(a,b){this.width=a,this.height=b,this.controller.setDimensions(a,b)},b.clear=function(){this.model.clear(),this.view.clear(),this.controller.clear()},b.remove=function(){this.queue.remove(),this.model.remove(),this.controller.remove(),this.view.remove(),this.queue=null,this.model=null,this.controller=null,this.view=null},b._setupFunctionForwarding=function(){var a=this.controller;this.addCommand=_.bind(a.addCommand,a),this.replaceLastCommand=_.bind(a.replaceLastCommand,a),this.clearLastCommand=_.bind(a.clearLastCommand,a),this.highlightLayer=_.bind(a.highlightLayer,a),this.undo=_.bind(a.undo,a),this.redo=_.bind(a.redo,a),this.setTargetLayer=_.bind(a.setTargetLayer,a),this.scroll=_.bind(a.scroll,a),this.update=_.bind(this.view.update,this.view),this.getSnapshot=_.bind(this.view.getSnapshot,this.view)},bigRender.BigRender=a}();var bigRender=bigRender||{};bigRender.event={DIMENSIONS_CHANGED:"dimensionsChanged",TARGET_LAYER_CHANGED:"targetLayerChanged",HIGHLIGHT_LAYER_CHANGED:"highlightLayerChanged",LAYER_ADDED:"layerAdded",LAYER_REMOVED:"layerRemoved",LAYER_CHANGED:"layerChanged",LAYER_RESIZED:"layerResized",COMMAND_POS_CHANGED:"commandPosChanged",SCROLL_CHANGED:"scrollChanged",COMPLETE:"complete",PROGRESS:"progress"},bigRender.command={CREATE_LAYER:"createLayer",DELETE_LAYER:"deleteLayer",EDIT_LAYER:"editLayer",ADD_OBJECT:"addObject",MOVE_OBJECT:"moveObject",REMOVE_OBJECT:"removeObject",MOVE_RECT:"moveRect",ERASE_RECT:"eraseRect",DRAW_LINE:"drawLine",DRAW_SHAPE:"drawShape",DRAW_IMAGE:"drawImage",FLOOD_FILL:"floodFill"},bigRender.brush={LINE:"line",IMAGE:"image",SHAPE:"shape",PIXEL:"pixel"},bigRender.blendMode={NORMAL:"normal",ERASE:"erase"},bigRender.shape={RECTANGLE:"rectangle",ROUND_RECTANGLE:"roundRectangle",ELLIPSE:"ellipse",CIRCLE:"circle",POLYGON:"polygon",STAR:"star"};